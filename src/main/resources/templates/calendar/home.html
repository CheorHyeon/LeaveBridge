<html layout:decorate="~{common/layout}">
<head>
    <style>
        /* 날짜 숫자를 가로·세로 중앙 정렬 */
        .fc .fc-daygrid-day-top {
            display: flex;
            justify-content: center; /* 가로 중앙 정렬 */
            align-items: center; /* 세로 중앙 정렬 */
        }

        /* daygrid 뷰의 날짜 셀 hover 시 배경색 변경 */
        .fc .fc-daygrid-day:hover {
            background-color: #f0f8ff;
            cursor: pointer;
        }

        /* dayGrid(월간) 뷰의 all‑day 이벤트 */
        .fc .fc-daygrid-event {
            margin-bottom: 4px; /* 아래쪽 간격 */
        }

        /* timeGrid(시간) 뷰의 이벤트 컨테이너 */
        .fc .fc-timegrid-event-harness {
            margin-bottom: 4px; /* 아래쪽 간격 */
        }

        /* 필요하면 좌우 간격도 추가 */
        .fc .fc-event {
            margin: 2px 0; /* 세로 2px 여백 */
        }

        .select-readonly {
            pointer-events: none;      /* 클릭 불가 */
            background-color: #e9ecef; /* 입력 불가 느낌 */
            opacity: 1;                /* 흐려짐 방지 */
        }
    </style>
</head>
<div layout:fragment="content">
    <!-- 일정 입력/수정 모달 -->
    <div id="eventFormModal" class="modal fade" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <form id="eventForm" class="modal-content">
                <div class="modal-header">
                    <h5 id="formModalTitle" class="modal-title">일정 등록</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="inputTitle" class="form-label">일정 제목</label>
                        <input type="text" class="form-control" id="inputTitle" name="title" placeholder="박철현 연차"
                               required>
                    </div>

                    <!-- 종일+휴일 포함 체크박스 그룹 -->
                    <div class="d-flex align-items-center mb-3">
                        <!-- allDay -->
                        <div class="form-check form-check-inline me-3 mb-0">
                            <input class="form-check-input" type="checkbox"
                                   id="allDayCheck" name="isAllDay" value="true">
                            <label class="form-check-label" for="allDayCheck">
                                하루 종일 여부(All Day)
                            </label>
                        </div>
                        <!-- holidayInclude (관리자만) -->
                        <div class="form-check form-check-inline mb-0"
                             sec:authorize="hasRole('ADMIN')">
                            <input class="form-check-input" type="checkbox"
                                   id="holidayIncludeCheck" name="isHolidayInclude" value="true">
                            <label class="form-check-label" for="holidayIncludeCheck">
                                휴일 포함 여부
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="leaveType" class="form-label">휴가 유형</label>
                        <select id="leaveType" name="leaveType" class="form-select" required>
                            <option value="">-- 유형 선택 --</option>
                            <option value="FULL_DAY_LEAVE">연차</option>
                            <option value="HALF_DAY_MORNING">오전 반차</option>
                            <option value="HALF_DAY_AFTERNOON">오후 반차</option>
                            <option value="OUTING">외출(시간지정 연차)</option>
                            <option value="SUMMER_VACATION">여름휴가</option>
                            <option value="NON_DEDUCTIBLE">비차감 휴가(공가)</option>
                            <option value="MEETING">회의</option>
                            <option sec:authorize="hasRole('ADMIN')" value="PUBLIC_HOLIDAY">공휴일</option>
                            <option sec:authorize="hasRole('ADMIN')" value="ANNIVERSARY">기념일</option>
                        </select>
                        <div class="form-text fw-bold">
                            한 번에 하나의 연차 타입만 등록 가능합니다. 다른 타입은 별도 등록해 주세요.
                        </div>
                        <div class="form-text fw-bold" sec:authorize="hasRole('ADMIN')" id="holidayNotice"
                             style="display: none;">
                            휴일 포함 체크시 기존에 등록된 연차들은 차감 연차 조정되거나 삭제됩니다.
                        </div>
                    </div>

                    <!-- 날짜 입력(항상 보임) -->
                    <div class="row mb-3">
                        <div class="col">
                            <label for="inputStartDate" class="form-label">시작 날짜</label>
                            <input type="date" class="form-control" id="inputStartDate" name="startDate" required>
                            <div class="invalid-feedback">시작 날짜는 종료 날짜보다 빠를 수 없습니다.</div>
                        </div>
                        <div class="col">
                            <label for="inputEndDate" class="form-label">종료 날짜</label>
                            <input type="date" class="form-control" id="inputEndDate" name="endDate" required>
                        </div>
                    </div>

                    <!-- 시간 입력(체크박스에 따라 토글) -->
                    <div class="row mb-3" id="timeGroup" style="display: none;">
                        <div class="col">
                            <label for="inputStartTime" class="form-label">시작 시간</label>
                            <input type="time" class="form-control" id="inputStartTime" name="startTime">
                            <div class="invalid-feedback">시작 시간은 종료 시간보다 빠를 수 없습니다.</div>
                        </div>
                        <div class="col">
                            <label for="inputEndTime" class="form-label">종료 시간</label>
                            <input type="time" class="form-control" id="inputEndTime" name="endTime">
                        </div>
                    </div>
                    <!-- 비고 -->
                    <div class="mb-3">
                        <label for="inputDescription" class="form-label">비고</label>
                        <textarea class="form-control" id="inputDescription" name="description" rows="3"
                                  placeholder="공가 사유 등 입력(꼭 필요한 경우만 - 개인 연차 사용 미입력)"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <!-- <button> 요소에 type 속성을 명시하지 않으면 HTML5 기준에서 type="submit"이 디폴트 적용 -->
                    <button type="submit" class="btn btn-primary" id="submitBtn">일정 등록</button>
                    <button type="button" class="btn btn-secondary" id="cancelBtn" data-bs-dismiss="modal">등록 취소
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 이벤트 상세 모달 -->
    <div id="eventDetailModal" class="modal fade" tabindex="-1" aria-labelledby="eventDetailLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 id="modalTitle" class="modal-title">
                        <i class="bi bi-calendar-event me-2"></i>
                        이벤트 제목
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="닫기"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-12">
                            <dl class="row">
                                <dt class="col-sm-3">
                                    <i class="bi bi-clock me-1"></i>시작 시간
                                </dt>
                                <dd id="modalStart" class="col-sm-9">2025-07-10T10:00:00</dd>

                                <dt class="col-sm-3">
                                    <i class="bi bi-clock-history me-1"></i>종료 시간
                                </dt>
                                <dd id="modalEnd" class="col-sm-9">2025-07-10T12:00:00</dd>

                                <dt class="col-sm-3">
                                    <i class="bi bi-card-text me-1"></i>설명
                                </dt>
                                <dd id="modalDescription" class="col-sm-9">설명 없음</dd>

                                <!-- 휴일 표시: isHoliday가 true일 때만 -->
                                <dt class="col-sm-3" id="modalHolidayLabel" style="display:none">
                                    <i class="bi bi-calendar-event-fill me-1"></i>휴일
                                </dt>
                                <dd class="col-sm-9" id="modalHolidayInfo" style="display:none">
                                    <!-- allDay일 때와 아닐 때 구분 -->
                                    <span id="modalHolidayText"></span>
                                </dd>

                            </dl>
                        </div>
                    </div>
                </div>
                <div class="modal-footer d-flex justify-content-between">
                    <div class="btn-group-custom d-flex">
                        <button id="modalEditBtn" type="button" class="btn btn-outline-primary">
                            <i class="bi bi-pencil me-1"></i>수정
                        </button>
                        <button id="modalDeleteBtn" type="button" class="btn btn-outline-danger">
                            <i class="bi bi-trash me-1"></i>삭제
                        </button>
                    </div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>닫기
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 삭제 확인 모달 -->
    <div id="deleteConfirmModal" class="modal fade" tabindex="-1" aria-labelledby="deleteConfirmLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteConfirmLabel">
                        <i class="bi bi-exclamation-triangle me-2"></i>삭제 확인
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="닫기"></button>
                </div>
                <div class="modal-body">
                    <p>정말로 이 일정을 삭제하시겠습니까?</p>
                    <p class="text-muted">삭제된 일정은 복구할 수 없습니다.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button id="confirmDeleteBtn" type="button" class="btn btn-danger">삭제</button>
                </div>
            </div>
        </div>
    </div>

    <div id='calendar'></div>

    <script>
        /**
         * 오늘 날짜를 'YYYY-MM-DD' 형식의 문자열로 반환합니다.
         * @returns {string} 포맷된 날짜 문자열
         */
        function getFormattedDate() {
            const today = new Date();   // 현재 날짜/시간을 담은 Date 객체 생성
            const year = today.getFullYear();  // 4자리 연도 추출 (예: 2025)
            const month = String(today.getMonth() + 1) // 월은 0~11로 반환하므로 +1 필요
                .padStart(2, '0');                     // 한 자리일 때 앞에 '0' 추가
            const day = String(today.getDate())    // 1~31 사이 일자 반환
                .padStart(2, '0');                     // 한 자리일 때 앞에 '0' 추가

            return `${year}-${month}-${day}`;  // 템플릿 리터럴로 최종 문자열 조합
        }

        /*
            좀 더 친숙한 시간 표현대로 변경하는 함수
         */
        function formatKoreanDateTime(dateStr, timeStr) {
            // ISO 문자열로 합치기
            // timeStr이 초(sec)까지 포함하지 않을 수도 있어서 pad 보장
            const normalizedTime = timeStr.length === 5
                ? `${timeStr}:00`
                : timeStr;
            const isoString = `${dateStr}T${normalizedTime}`;

            // Date 객체 생성 (로컬 타임존 기반)
            const dt = new Date(isoString);

            // Intl.DateTimeFormat 으로 한 번에 포맷
            return new Intl.DateTimeFormat('ko-KR', {
                year:   'numeric',
                month:  'long',
                day:    'numeric',
                hour:   'numeric',
                minute: 'numeric',
                hour12: true
            }).format(dt);
        }

        function onModifyToggleAllDayChange() {
            const allDayCheck = document.getElementById('allDayCheck');
            const timeGroup = document.getElementById('timeGroup');
            const startTime = document.getElementById('inputStartTime');
            const endTime = document.getElementById('inputEndTime');
            if (allDayCheck.checked) {
                // 종일: 시간 입력 숨기기
                timeGroup.style.display = 'none';
                startTime.required = false;
                endTime.required = false;

                // 범위·값 모두 제거
                startTime.value = '00:00';
                endTime.value   = '23:59';
                startTime.removeAttribute('min');
                startTime.removeAttribute('max');
                endTime.removeAttribute('min');
                endTime.removeAttribute('max');
            } else {
                // 시간 지정: 시간 입력 보이기
                timeGroup.style.display = '';
                startTime.required = true;
                endTime.required = true;

                startTime.value = '';
                endTime.value   = '';
            }
        }

        const allDayCheck = document.getElementById('allDayCheck');
        allDayCheck.addEventListener('change', onModifyToggleAllDayChange);

        document.addEventListener('DOMContentLoaded', () => {
            // 1) 요소 조회
            const leaveTypeEl = document.getElementById('leaveType');
            const timeGroup = document.getElementById('timeGroup');
            const startTimeEl = document.getElementById('inputStartTime');
            const endTimeEl = document.getElementById('inputEndTime');
            const descriptionEl = document.getElementById('inputDescription');
            const formModal = new bootstrap.Modal(document.getElementById('eventFormModal'));
            const calendarEl = document.getElementById('calendar');
            const submitBtn = document.getElementById('submitBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const modalEditBtn = document.getElementById('modalEditBtn');
            const titleInput = document.getElementById('inputTitle');
            const startDateEl = document.getElementById('inputStartDate');
            const endDateEl = document.getElementById('inputEndDate');
            const detailEventModal = new bootstrap.Modal(document.getElementById('eventDetailModal'));
            const eventForm = document.getElementById('eventForm');
            const modalDeleteBtn = document.getElementById('modalDeleteBtn');
            const deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            const allDayCheck = document.getElementById('allDayCheck');
            const holidayIncludeCheck = document.getElementById('holidayIncludeCheck');
            const holidayIncludeGroup = holidayIncludeCheck?.closest('.form-check');
            const holidayNotice = document.getElementById('holidayNotice');

            if (holidayIncludeGroup) {
                holidayIncludeGroup.style.display = 'none';
            }

            let currentEventId = null;  // 수정 중인 이벤트 ID 보관
            let currentIsHoliday = false; // ← 전역 변수로 휴일 여부 저장

            allDayCheck.addEventListener('change', onModifyToggleAllDayChange);

            function resetValidation() {
                // invalid 클래스를 모두 제거
                eventForm.querySelectorAll('.is-invalid').forEach(el => {
                    el.classList.remove('is-invalid');
                });

                // 각 필드의 customValidity 도 초기화
                [startDateEl, endDateEl, startTimeEl, endTimeEl].forEach(el => {
                    el.setCustomValidity('');
                });
            }

            // 모달 DOM 요소
            const eventFormModalEl = document.getElementById('eventFormModal');
            // 폼 모달 닫기 버튼 눌렀을때도 validation 초기화
            eventFormModalEl.addEventListener('hidden.bs.modal', resetValidation);

            let anchorDate = null;         // 폼이 열릴 때 클릭한 날짜 기억

            function toggleHolidayIncludeUI(isHoliday) {
                if (typeof holidayIncludeCheck !== 'undefined' && holidayIncludeCheck !== null) {
                    // 1) 공휴일/기념일일 때만 보이기
                    holidayIncludeGroup.style.display = isHoliday ? '' : 'none';
                    holidayNotice.style.display = isHoliday ? '' : 'none';

                    // 2) 해당 일정이 휴일 여부에 따라 체크(최초 등록때는 안됨, 상세 조회 시에는 체크 여부 변경되게)
                    holidayIncludeCheck.checked = currentIsHoliday;
                }
            }

            // 3) leaveType 변경 시 UI 조정
            function onLeaveTypeChange() {
                const isHoliday = ['PUBLIC_HOLIDAY', 'ANNIVERSARY'].includes(leaveTypeEl.value);
                const currentType = leaveTypeEl.value;

                // holidayIncludeCheck 요소가 실제로 존재할 때만 동작
                toggleHolidayIncludeUI(isHoliday)
                // 0) 기본 리셋 (페어된 로직만 남김)
                allDayCheck.disabled = false;
                startTimeEl.required = false;
                endTimeEl.required = false;
                allDayCheck.checked = true;
                timeGroup.style.display = 'none';
                startDateEl.readOnly = false;
                endDateEl.readOnly = false;
                startTimeEl.readOnly = false;
                endTimeEl.readOnly = false;
                descriptionEl.required = false;
                startTimeEl.removeAttribute('min');
                startTimeEl.removeAttribute('max');
                endTimeEl.removeAttribute('min');
                endTimeEl.removeAttribute('max');

                // ✅ 반차·외출 3종은 “클릭한 날” 하루로 고정
                const isHalfOrOuting = ['HALF_DAY_MORNING', 'HALF_DAY_AFTERNOON', 'OUTING']
                    .includes(currentType);

                if (isHalfOrOuting && anchorDate) {     // dateClick 으로 열린 경우에만
                    startDateEl.value = anchorDate;
                    endDateEl.value = anchorDate;
                    startDateEl.readOnly = true;
                    endDateEl.readOnly = true;
                }


                // 1) 타입별 고유 설정
                switch (currentType) {
                    case '':
                        allDayCheck.checked = true;
                        startTimeEl.required = false;
                        endTimeEl.required = false;
                        return;

                    case 'FULL_DAY_LEAVE':
                    case 'SUMMER_VACATION':
                        allDayCheck.checked = true;
                        allDayCheck.disabled = true;
                        startTimeEl.value = '00:00';
                        endTimeEl.value = '23:59';
                        startDateEl.readOnly = false;
                        endDateEl.readOnly = false;
                        break;

                    case 'HALF_DAY_MORNING':
                        allDayCheck.checked = false;
                        allDayCheck.disabled = true;
                        timeGroup.style.display = '';
                        startTimeEl.value = '08:00';
                        endTimeEl.value = '13:00';
                        startDateEl.readOnly = true;
                        endDateEl.readOnly = true;
                        startTimeEl.readOnly = true;
                        endTimeEl.readOnly = true;
                        return;  // 범위 세팅도 필요 없으니 리턴

                    case 'HALF_DAY_AFTERNOON':
                        allDayCheck.checked = false;
                        allDayCheck.disabled = true;
                        timeGroup.style.display = '';
                        startTimeEl.value = '13:00';
                        endTimeEl.value = '17:00';
                        startDateEl.readOnly = true;
                        endDateEl.readOnly = true;
                        startTimeEl.readOnly = true;
                        endTimeEl.readOnly = true;
                        return;

                    case 'OUTING':
                        allDayCheck.checked = false;
                        allDayCheck.disabled = true;
                        timeGroup.style.display = '';
                        startDateEl.readOnly = true;
                        endDateEl.readOnly = true;
                        startTimeEl.min = '08:00';
                        startTimeEl.max = '17:00';
                        endTimeEl.min = '08:00';
                        endTimeEl.max = '17:00';
                        break;

                    case 'NON_DEDUCTIBLE':
                        descriptionEl.required = true
                        break;

                    case 'MEETING':
                        break;

                    default:
                        break;
                }

            }

            leaveTypeEl.addEventListener('change', onLeaveTypeChange);


            // “수정” 버튼 클릭 핸들러
            modalEditBtn.addEventListener('click', (e) => {
                // 상세 모달 닫기
                detailEventModal.hide();
                const eventId = e.currentTarget.getAttribute('data-event-id');

                // 기존 입력 모달 초기화
                document.getElementById('eventForm').reset();
                resetValidation();
                submitBtn.disabled = false;

                // 모드 전환
                document.getElementById('formModalTitle').textContent = '일정 수정';
                submitBtn.textContent = '수정하기';
                cancelBtn.textContent = '수정취소'


                fetch(`/api/v1/calendar/events/${eventId}`)
                    .then(res => res.json())
                    .then(evt => {
                        // 전역 변수에 isHoliday 저장
                        currentIsHoliday = evt.isHoliday;

                        // 2) 폼 필드에 값 채우기
                        titleInput.value = evt.title;
                        leaveTypeEl.value = evt.leaveType;
                        startDateEl.value = evt.startDate;
                        endDateEl.value = evt.endDate;
                        startTimeEl.value = evt.startTime;
                        endTimeEl.value   = evt.endTime;

                        if (!evt.isAllDay) {
                            allDayCheck.checked = false;
                            startTimeEl.value = evt.startDate;
                            endTimeEl.value = evt.endDate;
                        } else {
                            allDayCheck.checked = true;
                        }
                        // holidayIncludeCheck 엘리먼트가 있을 때만 접근
                        if (holidayIncludeCheck) {
                            holidayIncludeCheck.checked = Boolean(evt.isHoliday);
                            // 수정 불가 설정도 함께
                            holidayIncludeCheck.disabled = currentIsHoliday;
                        }
                        descriptionEl.value = evt.description || '';

                        // isHoliday인 경우 → 수정 불가 필드 비활성화
                        if (currentIsHoliday) {
                            // 날짜, 시간, all-day, 휴일 포함 체크박스 전부 비활성화
                            startDateEl.readOnly = true;
                            endDateEl.readOnly = true;
                            allDayCheck.disabled = true;
                            if (holidayIncludeCheck) holidayIncludeCheck.disabled = true;
                            startTimeEl.readOnly = true;
                            endTimeEl.readOnly = true;
                            leaveTypeEl.disabled = true;
                            toggleHolidayIncludeUI(currentIsHoliday)
                            holidayNotice.textContent = '등록된 휴일의 일정을 조절할 수 없습니다. 조절이 필요하면 삭제 후 다시 일정을 생성하세요.';
                            holidayNotice.style.display = '';  // 보이도록
                        } else {
                            // 일반 일정이면 leaveType까지 편집 가능
                            startDateEl.readOnly = false;
                            endDateEl.readOnly = false;
                            allDayCheck.disabled = false;
                            if (holidayIncludeCheck) holidayIncludeCheck.disabled = false;
                            startTimeEl.readOnly = false;
                            endTimeEl.readOnly = false;
                            leaveTypeEl.disabled = false;
                            // 3) onLeaveTypeChange 등 UI 토글 함수 호출
                            onLeaveTypeChange();
                        }

                        formModal.show();
                    })
                    .catch(console.error);
            });

            // 4) FullCalendar 초기화
            let calendar = new FullCalendar.Calendar(calendarEl, {
                themeSystem: 'bootstrap5',
                // 여러 속성들
                initialView: 'dayGridMonth',  // 초기 보기 설정, 기본값 dayGridMonth
                initialDate: getFormattedDate(),  // 캘린더 로드 시 초기 날짜 설절, 기본값 오늘 날짜
                // displayEventEnd: true,    // 종료 시간도 함께 표시
                locale: 'ko',  // 언머 및 지역화 설정 변경
                timeZone: 'Asia/Seoul', // IANA 시간대 설정(명명된 시간대)
                weekends: true,  // 주말 포함 여부 기본값 true
                height: '100%',   // 100%의 경우 부모 컨테이너 요소 높이와 일치
                contentHeight: 'auto',  // 본문 영역 높이 auto시 뷰 높이 자연스럽고 스크롤바 사용 안함
                aspectRatio: 1.5, // 너비: 높이 비율 1.5:1 (종횡비)
                eventColor: '#3799d8',  // 기본 일정 배경색 설정 (파란색)
                eventTextColor: '#ffffff',  // 글자 색상 변경
                dayMaxEvents: false,  // 하루 최대 이벤트 표시(true 인경우 적절히)
                eventOrder: 'duration, start',  // duration이 긴(다중일) 이벤트 우선 렌더
                eventDisplay: 'block',        // 이벤트가 블록으로 렌더
                // moreLinkClick: function (info) {
                //     alert('더보기 클릭: ' + info.data);
                //     // 여기서 팝업을 열거나 다른 행동 정의할 수 있음
                //     return false; // 기본 팝업 열림 방지(false: 팝업 열림, true: 팝업 안열림)
                // },
                selectable: true,   // 사용자가 선택하고 취소되는 시점 모니터링
                headerToolbar: {
                    left: 'prev next',
                    center: 'title',
                    right: 'dayGridMonth timeGridWeek timeGridDay'
                },
                views: {
                    dayGridMonth: {
                        titleFormat: {
                            year: 'numeric',
                            month: '2-digit'
                        }
                    }
                },
                buttonText: {
                    today: '현재날짜',
                    month: '월',
                    week: '주',
                    day: '일'
                },

                // 서버에서 일정 JSON 데이터 로드
                events: (info) => {
                    // info.start : 화면에 표시된 달력 첫날
                    // 달력의 첫날은 매월 1일이 보장 안되기에(이전달의 30일 일수도) 10일정도 더해서 월 맞추기 위함
                    const tenDaysMs = 10 * 24 * 60 * 60 * 1000;  // 10일
                    const midDate = new Date(info.start.getTime() + tenDaysMs);

                    const y = midDate.getFullYear();      // 예: 2025
                    const m = midDate.getMonth() + 1;     // 1~12

                    return fetch(`/api/v1/calendar/events/${y}/${m}`)
                        .then(res => {
                            if (!res.ok) throw new Error('네트워크 에러');
                            return res.json();
                        })
                        .then(events => {
                            // events 는 MonthlyEvent DTO 배열이라고 가정
                            return events.map(evt => ({
                                id: evt.id,
                                title: evt.title,
                                start: evt.start,
                                end: evt.end,
                                allDay: evt.allDay,
                                // isHoliday 플래그에 따라 색상 지정
                                backgroundColor: evt.isHoliday ? '#dc3545' : undefined,
                                borderColor: evt.isHoliday ? '#dc3545' : undefined,
                                textColor: evt.isHoliday ? '#ffffff' : undefined,
                            }));
                            successCallback(fcEvents);
                        })
                        .catch(err => {
                            console.error(err);
                            showToast('일정을 불러오는 중 오류가 발생했습니다.', 'error');
                            // 실패 콜백에 빈 배열을 넘겨줘서 캘린더가 비어 있게 함
                            failureCallback([]);
                        });
                    ;
                },

                // event 클릭 함수 정의 -> 일정 정보 (수정, 삭제 가능하도록)
                eventClick: function (info) {
                    currentEventId = info.event.id;

                    // 서버에서 상세 정보 불러오기
                    fetch(`/api/v1/calendar/events/${currentEventId}`)
                        .then(response => {
                            if (!response.ok) throw new Error('네트워크 응답 실패');
                            return response.json();
                        })
                        .then(data => {
                            // 모달 내부 요소에 데이터 채우기
                            document.getElementById('modalTitle').textContent = data.title;
                            document.getElementById('modalStart').textContent = formatKoreanDateTime(data.startDate, data.startTime);
                            document.getElementById('modalEnd').textContent = formatKoreanDateTime(data.endDate, data.endTime);
                            document.getElementById('modalDescription').textContent = data.description || '설명 없음';

                            // 수정 버튼에 eventId 속성으로 넣기
                            document.getElementById('modalEditBtn').setAttribute('data-event-id', currentEventId);

                            // 2) 권한이 있을 때만 버튼 보이기 (백엔드에서 isOwner 혹은 canEdit 필드 제공)
                            if (data.isOwner) {
                                modalEditBtn.style.display = '';
                                modalDeleteBtn.style.display = '';
                                modalEditBtn.setAttribute('data-event-id', currentEventId);
                            } else {
                                modalEditBtn.style.display = 'none';
                                modalDeleteBtn.style.display = 'none';
                            }

                            // 휴일 라벨·정보 토글
                            const isHoliday = data.isHoliday;
                            document.getElementById('modalHolidayLabel').style.display = isHoliday ? '' : 'none';
                            document.getElementById('modalHolidayInfo').style.display = isHoliday ? '' : 'none';

                            if (isHoliday) {
                                let text;
                                if (data.isAllDay) {
                                    // DTO의 isAllDay 플래그 활용
                                    text = '종일';
                                } else {
                                    // DTO의 startTime, endTime을 바로 포맷
                                    const fmt = t => t.padStart(5, '0'); // "9:0" → "09:00"
                                    text = `${fmt(data.startTime)} ~ ${fmt(data.endTime)}`;
                                }
                                document.getElementById('modalHolidayText').textContent = text;
                            }

                            // Bootstrap 모달 표시
                            detailEventModal.show();
                        })
                        .catch(err => {
                            console.error('이벤트 상세 조회 중 오류:', err);
                            showToast('이벤트 정보를 불러오는 데 실패했습니다.', 'error');
                        });
                },

                // 날짜나 시간 클릭 시 발생 -> 일정 생성 폼 등록
                dateClick: function (info) {
                    // ➊ 로그인하지 않은 경우
                    if (!window.isAuthenticated) {
                        showToast('일정 등록은 로그인 후 가능합니다.', 'warning');
                        return;
                    }

                    // const day = info.date.getDay();
                    // // 일요일(0) 또는 토요일(6) 이면
                    // if (day === 0 || day === 6) {
                    //     showToast('주말은 일정 등록할 수 없습니다.', 'warning');
                    //     return;
                    // }
                    // 등록 모드 진입 시 기존 ID 초기화
                    currentEventId = null;
                    // 전역 변수에 클릭한 날짜 저장
                    anchorDate = info.dateStr;
                    // 1) 모달 제목 설정 (등록 모드)
                    document.getElementById('formModalTitle').textContent = '일정 등록';
                    submitBtn.textContent = '등록하기';
                    cancelBtn.textContent = '등록취소';
                    // 2) 폼 리셋 & 일정 등록 버튼 활성화
                    document.getElementById('eventForm').reset();
                    resetValidation();
                    submitBtn.disabled = false
                    // 3) “종일” 체크 & 토글
                    const allDayCheck = document.getElementById('allDayCheck');
                    allDayCheck.checked = true;        // 종일 모드로 강제 전환

                    // 4) 날짜 입력값을 클릭한 날짜로 초기화
                    document.getElementById('inputStartDate').value = info.dateStr;
                    document.getElementById('inputEndDate').value = info.dateStr;

                    // 5) 모달 띄우기
                    formModal.show();
                }

            });
            calendar.render();
            window.calendar = calendar;

            // 5) 페이지 로드 직후에도 선택값 반영
            onLeaveTypeChange();


            // 1) Bootstrap 5 모달 닫기
            function closeEventFormModal() {
                formModal.hide();
            }

            // 2) FullCalendar 이벤트 다시 불러오기
            function refreshCalendarEvents() {
                calendar.refetchEvents();
            }

            // ➊ 검증 함수
            function validateDateTime() {
                const sd = startDateEl.value;        // "2025-07-30"
                const ed = endDateEl.value;          // ""
                const st = startTimeEl.value;        // "13:00"
                const et = endTimeEl.value;

                // 1) 날짜 비교
                if (sd && ed && sd > ed) {           // YYYY-MM-DD는 문자열 비교 OK
                    startDateEl.setCustomValidity('invalid-date');
                    startDateEl.classList.add('is-invalid');
                    return false;
                }
                // 2) 시간 비교 (allDay 아니어야 함)
                if (!allDayCheck.checked && st && et && st >= et) {
                    startTimeEl.setCustomValidity('invalid-time');
                    startTimeEl.classList.add('is-invalid');
                    return false;
                }

                /* 모두 통과 → 기존 오류 리셋 */
                [startDateEl, startTimeEl].forEach(el => {
                    el.setCustomValidity('');
                    el.classList.remove('is-invalid');
                });
                return true;
            }

            // 폼 제출 이벤트 잡기 - form 태그 안에 button 있으면 제출
            eventForm.addEventListener('submit', function (e) {
                e.preventDefault();

                if (!validateDateTime()) {
                    // HTML5 기본 메시지 대신 invalid-feedback 이 보여짐
                    eventForm.reportValidity();        // 포커스 이동 + 빨간 테두리
                    return;                            // Fetch 보내지 않음
                }

                const url = currentEventId
                    ? `/api/v1/calendar/events/${currentEventId}`
                    : '/api/v1/calendar/events';
                const method = currentEventId ? 'PATCH' : 'POST';

                // ① disabled 풀고
                const disabledEls = eventForm.querySelectorAll('[disabled]');
                disabledEls.forEach(el => el.disabled = false);

                // ② FormData 뽑기
                const formData = new FormData(eventForm);
                const dataObj = Object.fromEntries(formData.entries());

                // ③ 다시 disabled 복귀
                disabledEls.forEach(el => el.disabled = true);

                // 2) allDay 키가 없으면 기본 false 주입 (문자열 → boolean 변환 포함)
                dataObj.isAllDay = document.getElementById('allDayCheck').checked; // true / false

                // holidayInclude도 boolean값 전달
                if (typeof holidayIncludeCheck !== 'undefined' && holidayIncludeCheck !== null) {
                    dataObj.isHolidayInclude = holidayIncludeCheck.checked;
                }

                // 2) 등록 버튼 비활성화
                submitBtn.disabled = true;

                fetch(url, {
                    method: method,
                    headers: requestHeaders,
                    body: JSON.stringify(dataObj)
                })
                    .then(res => {
                        if (!res.ok) throw new Error('서버 오류');
                        return res.json().catch(() => null);
                    })
                    .then(() => {
                        showToast(currentEventId ? '수정에 성공했습니다.' : '등록에 성공했습니다.', 'success');
                        currentEventId = null;
                        closeEventFormModal();      // 모달 닫기
                        refreshCalendarEvents();    // 캘린더 갱신
                    })
                    .catch(err => {
                        console.error(err);
                        showToast('요청에 실패했습니다.', 'error');
                    })
                    .finally(() => {
                        submitBtn.disabled = false;
                    });
            });

            // 상세 모달의 “삭제” 버튼 클릭 → 삭제 확인 모달 띄우기
            modalDeleteBtn.addEventListener('click', () => {
                deleteConfirmModal.show();
            });

            // 삭제 확인 모달의 “삭제” 버튼 클릭 → API 호출, 모달 닫기, 캘린더 리프레시
            confirmDeleteBtn.addEventListener('click', () => {
                // 삭제 버튼 따닥 연속 클릭 안되게
                confirmDeleteBtn.disabled = true;
                const cancelDeleteBtn = document.querySelector('#deleteConfirmModal .btn-secondary');
                cancelDeleteBtn.disabled = true;

                fetch(`/api/v1/calendar/events/${currentEventId}`, {
                    method: 'DELETE',
                    headers: requestHeaders
                })
                    .then(res => {
                        if (!res.ok) throw new Error('삭제 실패');
                        deleteConfirmModal.hide();
                        detailEventModal.hide();
                        refreshCalendarEvents();
                        showToast('일정 삭제 성공', 'success');
                    })
                    .catch(err => {
                        console.error(err);
                        showToast('삭제 요청에 실패했습니다.', 'error');
                    })
                    .finally(() => {
                        confirmDeleteBtn.disabled = false;
                        cancelDeleteBtn.disabled = false;
                    });
            });

        });

    </script>
</div>
</html>