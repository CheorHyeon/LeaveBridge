<!DOCTYPE html>
<html lang='ko'>
<head>
    <title>LeaveBridge</title>
    <style>
        @font-face {
            font-family: 'Pretendard-Regular';
            src: url('https://fastly.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-Regular.woff') format('woff');
            font-weight: 400;
            font-style: normal;
        }

        html * {
            font-family: 'Pretendard-Regular', sans-serif;
        }
    </style>
    <meta charset='utf-8'/>
    <!-- Bootstrap 5 기본 스타일 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

    <!-- 1) 표준 FullCalendar 번들 (core + interaction + dayGrid + timeGrid + list + multimonth) -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.17/index.global.min.js"></script>
    <!-- 2) Bootstrap5 테마 플러그인 -->
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/bootstrap5@6.1.17/index.global.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>


</head>

<body>

<!-- 이벤트 상세 모달 -->
<div id="eventDetailModal" class="modal fade" tabindex="-1" aria-labelledby="eventDetailLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 id="modalTitle" class="modal-title">
                    <i class="bi bi-calendar-event me-2"></i>
                    이벤트 제목
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="닫기"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-12">
                        <dl class="row">
                            <dt class="col-sm-3">
                                <i class="bi bi-clock me-1"></i>시작 시간
                            </dt>
                            <dd id="modalStart" class="col-sm-9">2025-07-10T10:00:00</dd>

                            <dt class="col-sm-3">
                                <i class="bi bi-clock-history me-1"></i>종료 시간
                            </dt>
                            <dd id="modalEnd" class="col-sm-9">2025-07-10T12:00:00</dd>

                            <dt class="col-sm-3">
                                <i class="bi bi-card-text me-1"></i>설명
                            </dt>
                            <dd id="modalDescription" class="col-sm-9">세부 일정 및 준비물</dd>
                        </dl>
                    </div>
                </div>
            </div>
            <div class="modal-footer d-flex justify-content-between">
                <div class="btn-group-custom d-flex">
                    <button id="modalEditBtn" type="button" class="btn btn-outline-primary">
                        <i class="bi bi-pencil me-1"></i>수정
                    </button>
                    <button id="modalDeleteBtn" type="button" class="btn btn-outline-danger">
                        <i class="bi bi-trash me-1"></i>삭제
                    </button>
                </div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>닫기
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 삭제 확인 모달 -->
<div id="deleteConfirmModal" class="modal fade" tabindex="-1" aria-labelledby="deleteConfirmLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteConfirmLabel">
                    <i class="bi bi-exclamation-triangle me-2"></i>삭제 확인
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="닫기"></button>
            </div>
            <div class="modal-body">
                <p>정말로 이 일정을 삭제하시겠습니까?</p>
                <p class="text-muted">삭제된 일정은 복구할 수 없습니다.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button id="confirmDeleteBtn" type="button" class="btn btn-danger">삭제</button>
            </div>
        </div>
    </div>
</div>



<!-- 1) 상단 네비게이션 바 -->
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">LeaveBridge</a> <!-- 홈으로 -->
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mb-2 mb-lg-0">
                <!-- 연차사용현황 버튼 -->
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/usage}">연차사용현황</a>
                </li>
                <!-- 로그인 or 로그아웃 -->
                <li>
                    <a class="nav-link font-bold" sec:authorize="isAnonymous()" th:href="@{/user/login}">로그인</a>
                    <a sec:authorize="isAuthenticated()" class="nav-link" href="javascript:;"
                       onclick="this.nextElementSibling.submit();">로그아웃</a>
                    <form sec:authorize="isAuthenticated()" method="POST" hidden th:action="@{/user/logout}"></form>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div id='calendar'></div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        let calendarEl = document.getElementById('calendar');
        let calendar = new FullCalendar.Calendar(calendarEl, {
            themeSystem: 'bootstrap5',
            // 여러 속성들
            initialView: 'dayGridMonth',  // 초기 보기 설정, 기본값 dayGridMonth
            initialDate: getFormattedDate(),  // 캘린더 로드 시 초기 날짜 설절, 기본값 오늘 날짜
            displayEventEnd: true,    // 종료 시간도 함께 표시
            locale: 'ko',  // 언머 및 지역화 설정 변경
            timeZone: 'Asia/Seoul', // IANA 시간대 설정(명명된 시간대)
            weekends: true,  // 주말 포함 여부 기본값 true
            height: '100%',   // 100%의 경우 부모 컨테이너 요소 높이와 일치
            contentHeight: 'auto',  // 본문 영역 높이 auto시 뷰 높이 자연스럽고 스크롤바 사용 안함
            aspectRatio: 1.5, // 너비: 높이 비율 1.5:1 (종횡비)
            eventColor: '#3799d8',  // 기본 일정 배경색 설정 (파란색)
            eventTextColor: '#ffffff',  // 글자 색상 변경
            dayMaxEvents: true,  // 하루 최대 이벤트 표시(true 인경우 적절히)
            // moreLinkClick: function (info) {
            //     alert('더보기 클릭: ' + info.data);
            //     // 여기서 팝업을 열거나 다른 행동 정의할 수 있음
            //     return false; // 기본 팝업 열림 방지(false: 팝업 열림, true: 팝업 안열림)
            // },
            selectable : true,   // 사용자가 선택하고 취소되는 시점 모니터링
            headerToolbar: {
                left: 'prev next',
                center: 'title',
                right: 'dayGridMonth timeGridWeek timeGridDay'
            },
            views: {
                dayGridMonth: {
                    titleFormat: {
                        year: 'numeric',
                        month: '2-digit'
                    }
                }
            },
            buttonText: {
                today : '현재날짜',
                month : '월',
                week: '주',
                day: '일'
            },

            // 서버에서 일정 JSON 데이터 로드
            events: (info) => {
                // info.start는 Date 객체이므로, getTime()으로 밀리초를 얻고
                // 10일 = 10 * 24 * 60 * 60 * 1000 밀리초를 더합니다.
                const tenDaysMs = 10 * 24 * 60 * 60 * 1000;
                const midDate   = new Date(info.start.getTime() + tenDaysMs);

                const y = midDate.getFullYear();      // 예: 2025
                const m = midDate.getMonth() + 1;     // 1~12

                // GET 요청 → Promise 반환
                return fetch(`/api/v1/calendar/events/${y}/${m}`)
                    .then(res => {
                        if (!res.ok) throw new Error('네트워크 에러');
                        return res.json();                // JSON 배열을 반환하는 Promise
                    });
            },

            // event 클릭 함수 정의 -> 일정 정보 (수정, 삭제 가능하도록)
            eventClick: function (info) {
                // 클릭된 이벤트의 ID 추출
                const eventId = info.event.id;

                // 서버에서 상세 정보 불러오기
                fetch(`/api/v1/calendar/events/${eventId}`)
                    .then(response => {
                        if (!response.ok) throw new Error('네트워크 응답 실패');
                        return response.json();
                    })
                    .then(data => {
                        // 모달 내부 요소에 데이터 채우기
                        document.getElementById('modalTitle').textContent       = data.title;
                        document.getElementById('modalStart').textContent       = data.startDate;
                        document.getElementById('modalEnd').textContent         = data.endDate;
                        document.getElementById('modalDescription').textContent = data.description || '설명 없음';

                        // 수정 버튼에 링크 설정 (원하면)
                        document.getElementById('modalEditBtn').href = `/events/edit/${eventId}`;

                        // Bootstrap 모달 표시
                        const modal = new bootstrap.Modal(document.getElementById('eventDetailModal'));
                        modal.show();
                    })
                    .catch(err => {
                        console.error('이벤트 상세 조회 중 오류:', err);
                        alert('이벤트 정보를 불러오는 데 실패했습니다.');
                    });
            },

            // 날짜나 시간 클릭 시 발생 -> 일정 생성 폼 등록
            dateClick: function (info) {
                alert('클릭한 날짜: ' + info.dateStr); // 클릭한 날짜
                // 일정 다시 불러오기(서버)
            }

        });
        calendar.render();
    });

</script>


<script>
    /**
     * 오늘 날짜를 'YYYY-MM-DD' 형식의 문자열로 반환합니다.
     * @returns {string} 포맷된 날짜 문자열
     */
    function getFormattedDate() {
        const today = new Date();   // 현재 날짜/시간을 담은 Date 객체 생성
        const year = today.getFullYear();  // 4자리 연도 추출 (예: 2025)
        const month = String(today.getMonth() + 1) // 월은 0~11로 반환하므로 +1 필요
            .padStart(2, '0');                     // 한 자리일 때 앞에 '0' 추가
        const day = String(today.getDate())    // 1~31 사이 일자 반환
            .padStart(2, '0');                     // 한 자리일 때 앞에 '0' 추가

        return `${year}-${month}-${day}`;  // 템플릿 리터럴로 최종 문자열 조합
    }


</script>
</body>
</html>