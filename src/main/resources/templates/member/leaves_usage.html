<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layout}">
<head>
    <title>연차 사용 현황</title>
</head>

<div layout:fragment="content">
        <h1 class="mb-4">연차 사용 현황</h1>

        <div class="row">
            <!-- 사용자 목록 (List Group) -->
            <div>
                <h5>사용자 목록</h5>
                <div id="user-list" class="d-flex flex-row flex-wrap">
                    <!-- JS로 채워집니다 -->
                </div>
            </div>

            <!-- 상세 테이블 영역 -->
            <div>
                <div id="usage-detail" class="card" style="display:none;">
                    <div class="card-body">
                        <h5 class="card-title">
                            연차 사용 현황: <span id="selected-user-name"></span>
                        </h5>
                        <p class="card-text mb-1">
                            <strong>총 잔여 연차:</strong> <span id="total-count"></span> 일
                        </p>
                        <p class="card-text mb-3">
                            <strong>총 사용 연차:</strong> <span id="used-days"></span> 일<br>
                            <strong>총 남은 연차:</strong> <span id="remaining-days"></span> 일
                        </p>

                        <div class="table-responsive">
                            <table class="table table-striped table-hover align-middle">
                                <thead class="table-light">
                                <tr>
                                    <th scope="col">순번</th>
                                    <th scope="col">제목</th>
                                    <th scope="col">설명</th>
                                    <th scope="col">시작</th>
                                    <th scope="col">종료</th>
                                    <th scope="col">사용일수</th>
                                    <th scope="col">타입</th>
                                </tr>
                                </thead>
                                <tbody id="detail-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <script>
        let membersData = [];

        document.addEventListener('DOMContentLoaded', () => {
            const listGroup = document.getElementById('user-list');

            // 1) 전체 사용자 API 호출
            fetch('/api/v1/member/used-leaves')
                .then(res => { if (!res.ok) throw new Error(); return res.json(); })
                .then(users => {
                    membersData = users;

                    // 2) List Group 아이템 생성
                    users.forEach(user => {
                        const btn = document.createElement('button');
                        btn.type        = 'button';
                        btn.className   = 'btn btn-outline-primary mx-2 my-2';  // 좌우 마진 mx-2, 상하 마진 my-2
                        btn.style.whiteSpace = 'nowrap';
                        btn.textContent = user.memberName;
                        btn.dataset.id  = user.memberId;
                        btn.addEventListener('click', onUserClick);
                        listGroup.appendChild(btn);
                    });
                })
                .catch(err => console.error(err));
        });

        function onUserClick() {
            // 1) 기존 active 제거
            document
                .querySelectorAll('#user-list button.active')
                .forEach(btn => btn.classList.remove('active'));

            // 2) 클릭된 버튼에만 active 추가
            this.classList.add('active');

            const memberId   = this.dataset.id;
            const memberName = this.textContent;
            document.getElementById('selected-user-name').textContent = memberName;

            const userRecord = membersData.find(u => String(u.memberId) === memberId);
            if (userRecord.leaveDetails) {
                renderDetails(userRecord);
            } else {
                fetch(`/api/member/leave/usage?memberId=${memberId}`)
                    .then(res => { if (!res.ok) throw new Error(); return res.json(); })
                    .then(data => {
                        Object.assign(userRecord, data);
                        renderDetails(userRecord);
                    })
                    .catch(err => console.error(err));
            }
        }

        function renderDetails(user) {
            document.getElementById('total-count').textContent    = user.totalCount;
            document.getElementById('used-days').textContent      = user.usedDays;
            document.getElementById('remaining-days').textContent = user.remainingDays;

            const tbody = document.getElementById('detail-body');
            tbody.innerHTML = '';

            user.leaveDetails.forEach((item, idx) => {
                const tr = document.createElement('tr');
                [
                    idx + 1,
                    item.title,
                    item.description,
                    item.start.replace('T',' '),
                    item.end.replace('T',' '),
                    item.usedDays,
                    item.leaveType
                ].forEach(text => {
                    const td = document.createElement('td');
                    td.textContent = text;
                    tr.append(td);
                });
                tbody.append(tr);
            });

            document.getElementById('usage-detail').style.display = 'block';
        }
    </script>
</div>
</html>
